<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>青果教务系统安卓APP(喜鹊儿)逆向分析 - uint128&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="uint128&#039;s Blog"><meta name="msapplication-TileImage" content="/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="uint128&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本文仅供学习交流，请勿用于违法用途。"><meta property="og:type" content="blog"><meta property="og:title" content="青果教务系统安卓APP(喜鹊儿)逆向分析"><meta property="og:url" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="uint128&#039;s Blog"><meta property="og:description" content="本文仅供学习交流，请勿用于违法用途。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic1.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic2.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic3.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic4.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic5.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic6.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic7.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic8.jpg"><meta property="og:image" content="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic9.jpg"><meta property="article:published_time" content="2020-08-20T10:58:34.000Z"><meta property="article:modified_time" content="2022-08-22T09:11:21.054Z"><meta property="article:author" content="uint128.com"><meta property="article:tag" content="uint128"><meta property="article:tag" content="uint128&#039;s blog"><meta property="article:tag" content="uint128.com"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="./pic1.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"},"headline":"uint128's Blog","image":["https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic1.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic2.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic3.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic4.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic5.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic6.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic7.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic8.jpg","https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/pic9.jpg"],"datePublished":"2020-08-20T10:58:34.000Z","dateModified":"2022-08-22T09:11:21.054Z","author":{"@type":"Person","name":"uint128.com"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject"}},"description":"本文仅供学习交流，请勿用于违法用途。"}</script><link rel="canonical" href="https://uint128.com/2020/08/20/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%8D%93APP-%E5%96%9C%E9%B9%8A%E5%84%BF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"><link rel="alternate" href="/atom.xml" title="uint128&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start -->
<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body class="is-2-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">uint128&#039;s Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="My GitHub" href="https://github.com/cyanray"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-20T10:58:34.000Z" title="2020/8/20 18:58:34">2020-08-20</time>发表</span><span class="level-item"><time dateTime="2022-08-22T09:11:21.054Z" title="2022/8/22 17:11:21">2022-08-22</time>更新</span></div></div><h1 class="title is-3 is-size-4-mobile">青果教务系统安卓APP(喜鹊儿)逆向分析</h1><div class="content"><p>本文仅供学习交流，请勿用于违法用途。<br><span id="more"></span></p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>博主第一次尝试 APK 逆向，以下分析内容针对 <em>v2.6.109</em> 版本的APP。</p>
<h2 id="基本分析"><a href="#基本分析" class="headerlink" title="基本分析"></a>基本分析</h2><p>首先是基本操作，使用 apktool 解压得到 classes.dex，然后使用 dex2jar 将 classes.dex 转化为 jar 文件，再使用 jd-gui 打开 jar 文件，查看反编译出来的代码。反编译结果如下图所示。</p>
<p><img src="./pic1.jpg" alt="使用jd-gui反编译的结果"></p>
<p>看到代码的第一反应是惊讶与疑惑，这代码也太少太简单了吧！我以为是反编译的结果不对，又使用 jadx-gui 打开这个 dex 文件。结果如下图所示。</p>
<p><img src="./pic2.jpg" alt="使用jadx-gui反编译的结果"></p>
<p>可以看出两个软件反编译的结果是一样的，也就是反编译的结果是没有问题的。使用文本搜索搜索了下一些文本，但是都找不到。很显然，这个 APP 真正的代码并没有被反编译出来。那么真正的代码都藏在了哪里呢？</p>
<p>查阅了一些有关 APK 加固的文章，一种识别 APK 被加固的方式是查看反编译出来的源代码的包名。比如有 tencent 字样，那么多半是腾讯的加固。这个 APP 反编译出来的源代码里确实有 alibaba 的字样，但是这个只是 fastjson 库的包名。结合网上的逆向资料来看，这也不像 alibaba 加固后的样子。</p>
<p>这个时候，我猜测这是一种自制的加固方式。浏览反编译出来的代码，里面的”AESEncrypt“、”ApplicationProxy“、”RefInvoke“ 和 ”SecurityUtils“ 让我更相信这个 APP 被加固了。</p>
<p>于是我开始仔细阅读里面的源代码，不久我就找到了一个很可能是突破口的函数。这是一个叫做 ”readDexFromApk“ 的函数，它的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] readDexFromApk() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">dexByteArrayOutputSteam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    System.out.println(getApplicationInfo().sourceDir);</span><br><span class="line">    <span class="type">ZipInputStream</span> <span class="variable">localZipInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(getApplicationInfo().sourceDir)));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">ZipEntry</span> <span class="variable">localZipEntry</span> <span class="operator">=</span> localZipInputStream.getNextEntry();</span><br><span class="line">        <span class="keyword">if</span> (localZipEntry == <span class="literal">null</span>) &#123;</span><br><span class="line">            localZipInputStream.close();</span><br><span class="line">            localZipInputStream.close();</span><br><span class="line">            <span class="keyword">return</span> dexByteArrayOutputSteam.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (localZipEntry.getName().equals(<span class="string">&quot;classes.dex&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> localZipInputStream.read(arrayOfByte);</span><br><span class="line">                <span class="keyword">if</span> (i == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                dexByteArrayOutputSteam.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码没有被混淆过，可读性很好。这段代码的大意是解压自己这个 apk 文件，逐个分析 apk 里面的文件，如果有名为 classes.dex 的文件，那么就读取这个 dex 文件的所有内容，最后返回读取到的内容。</p>
<p>这个函数被一个叫 multiThread 的函数调用。它的代码如下：</p>
<blockquote>
<p>这个函数很长，建议读者先往下读我对它的拆解分析，然后再回头阅读这个函数的代码。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">multiThread</span><span class="params">(String primaryDexDir)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = readDexFromApk();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shellDexLen</span> <span class="operator">=</span> data.length;</span><br><span class="line">        <span class="type">byte</span>[] dexFileCommentLenByte = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">        System.arraycopy(data, shellDexLen - <span class="number">4</span>, dexFileCommentLenByte, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">dexFileCommentLen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(dexFileCommentLenByte)).readInt();</span><br><span class="line">        <span class="type">byte</span>[] dexFileCommentByte = <span class="keyword">new</span> <span class="title class_">byte</span>[dexFileCommentLen];</span><br><span class="line">        System.arraycopy(data, (shellDexLen - <span class="number">4</span>) - dexFileCommentLen, dexFileCommentByte, <span class="number">0</span>, dexFileCommentLen);</span><br><span class="line">        <span class="type">String</span> <span class="variable">dexFileComment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(dexFileCommentByte);</span><br><span class="line">        LogUtils.m3d(<span class="string">&quot;dex comment:&quot;</span> + dexFileComment);</span><br><span class="line">        ArrayList&lt;DexFile&gt; dexFileArrayList = (ArrayList) JSON.parseArray(dexFileComment, DexFile.class);</span><br><span class="line">        <span class="type">int</span> <span class="variable">currentReadEndIndex</span> <span class="operator">=</span> (shellDexLen - <span class="number">4</span>) - dexFileCommentLen;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(dexFileArrayList.size());</span><br><span class="line">        <span class="type">ArrayList</span> <span class="variable">arrayList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        List&lt;String&gt; dexnamelist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> dexFileArrayList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">DexFile</span> <span class="variable">dexFile</span> <span class="operator">=</span> dexFileArrayList.get(i);</span><br><span class="line">            <span class="type">byte</span>[] primaryDexData = <span class="keyword">new</span> <span class="title class_">byte</span>[dexFile.getDexLength()];</span><br><span class="line">            System.arraycopy(data, currentReadEndIndex - dexFile.getDexLength(), primaryDexData, <span class="number">0</span>, dexFile.getDexLength());</span><br><span class="line">            arrayList.add(pool.submit(<span class="keyword">new</span> <span class="title class_">MyCallable</span>(i, primaryDexData, <span class="built_in">this</span>)));</span><br><span class="line">            dexnamelist.add(dexFile.getDexName());</span><br><span class="line">            currentReadEndIndex -= dexFile.getDexLength();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> arrayList.size() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (i2 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">byte</span>[] primaryDexData2 = (<span class="type">byte</span>[]) ((Future) arrayList.get(i2)).get(<span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">                System.out.println(<span class="string">&quot; primaryDexData encCD size=&quot;</span> + primaryDexData2.length);</span><br><span class="line">                <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(primaryDexDir, dexnamelist.get(i2));</span><br><span class="line">                <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                    file.createNewFile();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">                fileOutputStream.write(primaryDexData2);</span><br><span class="line">                fileOutputStream.close();</span><br><span class="line">                i2--;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="type">File</span> <span class="variable">odex</span> <span class="operator">=</span> getDir(<span class="string">&quot;payload_odex&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                getDir(<span class="string">&quot;payload_dex&quot;</span>, <span class="number">0</span>).delete();</span><br><span class="line">                odex.delete();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">                <span class="type">File</span> <span class="variable">odex2</span> <span class="operator">=</span> getDir(<span class="string">&quot;payload_odex&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                getDir(<span class="string">&quot;payload_dex&quot;</span>, <span class="number">0</span>).delete();</span><br><span class="line">                odex2.delete();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e3) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码首先调用 readDexFromApk 读取 APP 自己的 Dex 文件，把数据存入变量 data 中。然后读取了 Dex 文件最末尾的 4 个字节，以 int 类型解读这 4 个字节，存入到变量 dexFileCommentLen 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取 Dex 文件</span></span><br><span class="line"><span class="type">byte</span>[] data = readDexFromApk();</span><br><span class="line"><span class="comment">// Dex 文件的总长</span></span><br><span class="line"><span class="type">int</span> <span class="variable">shellDexLen</span> <span class="operator">=</span> data.length;</span><br><span class="line"><span class="type">byte</span>[] dexFileCommentLenByte = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line"><span class="comment">// 读取 Dex 文件最末尾的 4 个字节</span></span><br><span class="line">System.arraycopy(data, shellDexLen - <span class="number">4</span>, dexFileCommentLenByte0, <span class="number">4</span>);</span><br><span class="line"><span class="comment">// 以 int 类型解读这 4 个字节</span></span><br><span class="line"><span class="type">int</span> <span class="variable">dexFileCommentLen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(dexFileCommentLenByte)).readInt();</span><br></pre></td></tr></table></figure>
<p>结合变量名不难猜测，这个 int 变量描述的是一个 ”comment“ 的长度，而且是 ”dex file comment“。很显然，这个 App 的 dex 文件里另有乾坤，接下来多半是读取这个 ”dex file comment“，并且进行分析。</p>
<p>紧接着上面的这几行代码的大概含义是：从刚刚读取 4 个字节的位置继续<strong>向前</strong>读取 dexFileCommentLen 那么多个字节，并把这些字节数据以文本的形式解读，存入到  String 型变量 dexFileComment 中。最后用 JSON 库解析读取到的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] dexFileCommentByte = <span class="keyword">new</span> <span class="title class_">byte</span>[dexFileCommentLen];</span><br><span class="line"><span class="comment">// 往前继续读取 dexFileCommentLen 个字节的内容</span></span><br><span class="line">System.arraycopy(data, (shellDexLen - <span class="number">4</span>) - dexFileCommentLen , dexFileCommentByte, <span class="number">0</span>, dexFileCommentLen);</span><br><span class="line"><span class="comment">// 以文本的形式解读读取到的内容，存入到 string 变量中</span></span><br><span class="line"><span class="type">String</span> <span class="variable">dexFileComment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(dexFileCommentByte);</span><br><span class="line"><span class="comment">// 从类名猜测，这一句是在记录日志</span></span><br><span class="line">LogUtils.m3d(<span class="string">&quot;dex comment:&quot;</span> + dexFileComment);</span><br><span class="line"><span class="comment">// 用 JSON 库解析这段文本</span></span><br><span class="line">ArrayList&lt;DexFile&gt; dexFileArrayList = (ArrayList) JSOparseArray(dexFileComment, DexFile.class);</span><br></pre></td></tr></table></figure>
<p>读完上面的代码，看来我的思路是对的。这个 dexFileComment 不仅是文本，而且还是 JSON 格式的文本。接下来我已经迫不及待想要验证这段代码的真实性。</p>
<p>一开始我使用的是 VSCode + hexdump 插件来阅读 dex 文件，但是这个 dex 文件实在是太大了，受限于插件，根本读不到末尾的内容。于是我又使用 linux 里的 hexdump 工具查看。</p>
<p>在 wsl 中执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C classes.dex &gt; hexdump.txt</span><br></pre></td></tr></table></figure>
<p>最终得到的 hexdump.txt 足足有 100MB 那么大！我直接翻到末尾，内容如下：</p>
<p><img src="./pic3.jpg" alt="hexdump.txt末尾的内容"></p>
<p>可以看到，这个 App 的 dex 文件的末尾确实有一段 JSON 文本。最后四个字节的内容对应十进制 96，和 JSON 文本的长度一致。这说明上面的代码是真实有效的，确实是这次逆向的突破口。</p>
<p>顺着这个思路继续来解读这段 JSON 文本。根据这段 JSON 文本，可以了解到在哪个地方藏着两个 dex 文件，名字分别是 classes.dex 和 classes2.dex，同时给出了这两个文件的长度。</p>
<p>回到上面提到的 multiThread 这个函数的代码。JSON 库解析这段 JSON 文本后，得到了一个 DexFile 对象的数组。其中 DexFile 类的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DexFile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> dexLength;</span><br><span class="line">    <span class="keyword">private</span> String dexName;</span><br><span class="line">    <span class="comment">/* 省略了不重要的代码 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DexFile 类中的两个字段和看到的 JSON 文本里包含的字段是一致的。</p>
<p>multiThread 函数接下来会从读取完 dexFileComment 的位置继续往前读取内容，读取的长度来自于 DexFile 的 dexLength 字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> dexFileArrayList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="type">DexFile</span> <span class="variable">dexFile</span> <span class="operator">=</span> dexFileArrayList.get(i);</span><br><span class="line">    <span class="type">byte</span>[] primaryDexData = <span class="keyword">new</span> <span class="title class_">byte</span>[dexFile.getDexLength()];</span><br><span class="line">    System.arraycopy(data, currentReadEndIndex - dexFile.getDexLength(), primaryDexData, <span class="number">0</span>, dexFile.getDexLength());</span><br><span class="line">    arrayList.add(pool.submit(<span class="keyword">new</span> <span class="title class_">MyCallable</span>(i, primaryDexData, <span class="built_in">this</span>)));</span><br><span class="line">    dexnamelist.add(dexFile.getDexName());</span><br><span class="line">    currentReadEndIndex -= dexFile.getDexLength();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看来那两个藏起来的 dex 文件就藏在这个 App 的 dex 文件末尾。这两个隐藏起来的 dex 文件的数据，扔到了线程池里进行处理。这里的线程池很显然对应了这个函数名称 multiThread。原来这个函数的 “多线程” 指的是多线程处理被隐藏的 dex 文件数据。</p>
<p>我没有学习过 java 语言，但是我猜测任务交给线程池之后应该会执行 MyCallable 这个类的 call 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MyCallable</span> <span class="keyword">implements</span> <span class="title class_">Callable</span> &#123;</span><br><span class="line">    <span class="comment">/* 省略了不重要的代码 */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">byte</span>[] primaryDexData = Base64.decode(<span class="keyword">new</span> <span class="title class_">String</span>(SecurityUtils.AESDecrypt(AESEncrypt.decode(<span class="built_in">this</span>.innerapp, Base64.decode(Constant.AES_PRIVATE_KEY, <span class="number">2</span>), Constant.AES_IV, Constant.AES_TYPE, <span class="built_in">this</span>.innerDexData), <span class="string">&quot;UTF-8&quot;</span>), <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;程序运行时间： &quot;</span> + <span class="built_in">this</span>.num + <span class="string">&quot;--&quot;</span> + (System.nanoTime() - startTime) + <span class="string">&quot;ns&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> primaryDexData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我这么猜测不是毫无道理的，因为我认为被隐藏起来的 dex 很可能不会明文保存，不然开头看到的 AESEncrypt 类是干嘛用的？</p>
<p>这个 call 函数里正好用到了 AESEncrypt 类和 SecurityUtils 类。可以看出，这段代码确实是对刚刚读取的隐藏 dex 文件的数据进行解密。</p>
<p>上面这段代码中涉及的 Constan 类的内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Constant</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AES_IV</span> <span class="operator">=</span> <span class="string">&quot;1234567898765432&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AES_PRIVATE_KEY</span> <span class="operator">=</span> <span class="string">&quot;m/EEDbJozOx74V16O9VNgmcjCrhDfT/sMdENbl/MOiY=&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AES_TYPE</span> <span class="operator">=</span> <span class="string">&quot;AES/ECB/PKCS5Padding&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我猜测这里的内容指的是加密类型和密钥一类的参数。进一步可以猜测，被隐藏的 dex 文件是被 AES 算法加密的。</p>
<p>但是让我很疑惑的是，这段代码用到了两个 AES 解密的函数：“SecurityUtils.AESDecrypt” 和 “AESEncrypt.decode”，他们的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] AESDecrypt(String privateKey, String iv, String AES_TYPE, <span class="type">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv.getBytes());</span><br><span class="line">    <span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(privateKey.getBytes(), <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(AES_TYPE);</span><br><span class="line">    cipher.init(<span class="number">2</span>, key);</span><br><span class="line">    <span class="keyword">return</span> cipher.doFinal(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AESEncrypt</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">checkSignature</span><span class="params">(Object obj)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">decode</span><span class="params">(Object obj, <span class="type">byte</span>[] bArr)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">encode</span><span class="params">(Object obj, String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;JNIEncrypt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>暂且不管这两个函数的代码是什么意思。（实际上我并不了解 AES 算法，也读不懂这两个函数的代码）从这两个函数签名就可以分析到的是 SecurityUtils.AESDecrypt 需要的参数比 AESEncrypt.decode 的参数多了两个。</p>
<p>查阅资料了解到 AES 算法加解密是需要初始向量（即iv）和填充类型（PKCS5Padding）等参数的。</p>
<p>我实在无法理解为什么会有两个 AES 加解密的函数，我想程序员应该是非常懒而且非常讨厌重复的，在同一个程序里使用两个 AES 加解密类，实在不符合常理。</p>
<p>根据我的坏运气体质，写程序验证多半会解密失败。到时候要定位错误，同时涉及到两个 AES 解密，调试成本会很高。</p>
<p>因此我没有去验证这一段代码是不是真正的解密代码。</p>
<h2 id="柳暗花明"><a href="#柳暗花明" class="headerlink" title="柳暗花明"></a>柳暗花明</h2><p>我继续阅读其他的代码，重点挑选和 AES 有关的函数，很快发现了新的突破口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] decryAES(<span class="type">byte</span>[] data) &#123;</span><br><span class="line">    <span class="type">byte</span>[] baseDEC = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        baseDEC = Base64.decode(AESEncrypt.decode(<span class="built_in">this</span>, data), <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot; encCD size=&quot;</span> + baseDEC.length);</span><br><span class="line">        <span class="keyword">return</span> baseDEC;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> baseDEC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数只调用了 AESEncrypt.decode 进行解密，要写程序验证，即使解密出现失败，我也有信心调试出错误原因。于是我查了下这个函数的引用，它被 splitPrimaryDexFromShellDex 函数所调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">splitPrimaryDexFromShellDex</span><span class="params">(<span class="type">byte</span>[] data, String primaryDexDir)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">shellDexLen</span> <span class="operator">=</span> data.length;</span><br><span class="line">    <span class="type">byte</span>[] dexFileCommentLenByte = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">    System.arraycopy(data, shellDexLen - <span class="number">4</span>, dexFileCommentLenByte, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">dexFileCommentLen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(dexFileCommentLenByte)).readInt();</span><br><span class="line">    <span class="type">byte</span>[] dexFileCommentByte = <span class="keyword">new</span> <span class="title class_">byte</span>[dexFileCommentLen];</span><br><span class="line">    System.arraycopy(data, (shellDexLen - <span class="number">4</span>) - dexFileCommentLen, dexFileCommentByte, <span class="number">0</span>, dexFileCommentLen);</span><br><span class="line">    <span class="type">String</span> <span class="variable">dexFileComment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(dexFileCommentByte);</span><br><span class="line">    LogUtils.m3d(<span class="string">&quot;dex comment:&quot;</span> + dexFileComment);</span><br><span class="line">    ArrayList&lt;DexFile&gt; dexFileArrayList = (ArrayList) JSON.parseArray(dexFileComment, DexFile.class);</span><br><span class="line">    <span class="type">int</span> <span class="variable">currentReadEndIndex</span> <span class="operator">=</span> (shellDexLen - <span class="number">4</span>) - dexFileCommentLen;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> dexFileArrayList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">DexFile</span> <span class="variable">dexFile</span> <span class="operator">=</span> dexFileArrayList.get(i);</span><br><span class="line">        <span class="type">byte</span>[] primaryDexData = <span class="keyword">new</span> <span class="title class_">byte</span>[dexFile.getDexLength()];</span><br><span class="line">        System.arraycopy(data, currentReadEndIndex - dexFile.getDexLength(), primaryDexData, <span class="number">0</span>, dexFile.getDexLength());</span><br><span class="line">        <span class="type">byte</span>[] primaryDexData2 = decryAES(primaryDexData);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(primaryDexDir, dexFile.getDexName());</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">localFileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">        localFileOutputStream.write(primaryDexData2);</span><br><span class="line">        localFileOutputStream.close();</span><br><span class="line">        currentReadEndIndex -= dexFile.getDexLength();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数执行的流程和 multiThread 函数大致相同，也是读取隐藏的 dex 文件数据，然后对各个隐藏 dex 文件数据<strong>调用decryAES</strong>函数进行解密，解密后的数据保存到磁盘中。</p>
<p>相比于刚刚 call 函数里的解密方式，更容易去验证这个函数的解密方式是否正确。</p>
<p>解密的核心函数是 AESEncrypt.decode，这个函数的内容不在 java 层而在 native 层。看这个函数的定义就知道，带着“native”关键词，并且来自“JNIEncrypt”库。</p>
<p>调试 native 库就要用到工具 IDA 了。使用 IDA 打开 x86 目录下的 libJNIEncrypt.so 文件，如下图所示，找到 decode 函数后按下 F5 反编译为 c 语言代码。</p>
<p><img src="./pic4.jpg" alt="使用IDA分析decode函数"></p>
<p>从代码中的 AES_128_ECB_PKCS5Padding_Decrypt 函数可以了解到很多很多信息。AES 解密所需要的信息这里基本上都包含了。但是我很疑惑为什么这里解密没有用到初始向量（iv）。要知道 java 层的 AES 解密以及 Constants 类都有初始向量 iv 的定义。</p>
<p>查阅资料后发现，原来 AES 算法在 ECB 模式下，初始向量不是必要的参数。</p>
<blockquote>
<p>但是 java 层的也是 ECB 模式！为什么它还是用到了初始向量呢？我没有去进一步了解，往后看吧，我直接成功了。（剧透警告）</p>
</blockquote>
<p>分析一下我只看懂的三行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v6 感觉是密钥</span></span><br><span class="line">v6 = getKey();</span><br><span class="line"><span class="comment">// 使用密钥进行解密</span></span><br><span class="line">v7 = AES_128_ECB_PKCS5Padding_Decrypt(v4, v5, v6);</span><br><span class="line"><span class="comment">// 返回解密后的数据</span></span><br><span class="line"><span class="keyword">return</span> charToJstring(a1, v7);</span><br></pre></td></tr></table></figure>
<p>于是我去看了看 getKey 函数，我想这里能够知道密钥是怎么来的：</p>
<p><img src="./pic5.jpg" alt="使用IDA分析getKey函数"></p>
<p>这次我能看懂的代码只剩下 2 行了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对 v3 执行 strlen ？v3 不是 char 变量吗？</span></span><br><span class="line">v0 = <span class="built_in">strlen</span>(&amp;v3);</span><br><span class="line"><span class="comment">// b64_decode 应该是 base64 解码</span></span><br><span class="line">v2 = b64_decode(&amp;v3, v0);</span><br></pre></td></tr></table></figure>
<p>从C语言的语法来理解，v3 应该是 char 变量，是不应该对它使用 strlen 的，但是这里偏偏就对它使用了strlen。</p>
<p>无奈我是第一次使用 IDA，所以我只能认为不能用常规的C语言语法来理解这段代码。我猜测 v3 到 v26 那些变量，实际上是同一个字符串的内容，它们在内存中的位置是连续的。</p>
<p>我又注意到 v25 和 v26 的字符一样，结合 base64 编码的特性，我猜测这两个字符很可能就是两个等号。翻了翻 ASCII 码表，dec 61对应的字符确实是等号，我的想法是对的。</p>
<p>最终，我得到了下面这些数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;77 84 73 122 78 68 85 52 79 84 89 51 77 71 82 108 90 109 70 105 89 119 61 61&quot;</span></span><br><span class="line"><span class="string">&quot;MTIzNDU4OTY3MGRlZmFiYw==&quot;</span></span><br><span class="line"><span class="string">&quot;1234589670defabc&quot;</span></span><br></pre></td></tr></table></figure>
<p>虽然我是第一次进行 App 逆向，但是我见过别人的逆向文章，别人逆向出来的密钥，有很多都是 123456 这样的简单密钥。我也逆向出了个“1234589670defabc”，因此我逆向得到的也是密钥。（哈哈哈哈，别不信，我是对的）</p>
<p>接下来我用 C# 写了个程序，去验证我的猜想。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json.Linq;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">kgo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] dexData = File.ReadAllBytes(<span class="string">&quot;D:\\classes.dex&quot;</span>);</span><br><span class="line">            <span class="built_in">int</span> Len = dexData.Length;</span><br><span class="line">            <span class="built_in">byte</span>[] commentLenByte = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4</span>];</span><br><span class="line">            Array.Copy(dexData, Len - <span class="number">4</span>, commentLenByte, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            Array.Reverse(commentLenByte);</span><br><span class="line">            <span class="built_in">int</span> commentLen = BitConverter.ToInt32(commentLenByte);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;注释长度: <span class="subst">&#123;commentLen&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="built_in">byte</span>[] commentByte = <span class="keyword">new</span> <span class="built_in">byte</span>[commentLen];</span><br><span class="line">            Array.Copy(dexData, Len - <span class="number">4</span> - commentLen, commentByte, <span class="number">0</span>, commentLen);</span><br><span class="line">            <span class="built_in">string</span> comment = Encoding.UTF8.GetString(commentByte);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;注释内容：<span class="subst">&#123;comment&#125;</span>&quot;</span>);</span><br><span class="line">            List&lt;DexFile&gt; dexFiles = <span class="keyword">new</span> List&lt;DexFile&gt;();</span><br><span class="line">            dexFiles = JsonConvert.DeserializeObject&lt;List&lt;DexFile&gt;&gt;(comment);</span><br><span class="line">            <span class="built_in">int</span> tLen = Len - <span class="number">4</span> - commentLen;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = dexFiles.Count - <span class="number">1</span>; i &gt;=<span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> dexFile = dexFiles[i];</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;检测到 dex 文件: <span class="subst">&#123;dexFile.Name&#125;</span>, 总长度: <span class="subst">&#123;dexFile.Length&#125;</span>&quot;</span>);</span><br><span class="line">                tLen -= dexFile.Length;</span><br><span class="line">                <span class="built_in">byte</span>[] dexFileData = <span class="keyword">new</span> <span class="built_in">byte</span>[dexFile.Length];</span><br><span class="line">                Array.Copy(dexData, tLen, dexFileData, <span class="number">0</span>, dexFile.Length);</span><br><span class="line">                <span class="built_in">byte</span>[] de = Decrypt(dexFileData, Convert.FromBase64String(<span class="string">&quot;MTIzNDU4OTY3MGRlZmFiYw==&quot;</span>));</span><br><span class="line">                de = Convert.FromBase64String(Encoding.ASCII.GetString(de));</span><br><span class="line">                File.WriteAllBytes(<span class="string">$&quot;D:\\decode_<span class="subst">&#123;dexFile.Name&#125;</span>&quot;</span>, de);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Decrypt</span>(<span class="params"><span class="built_in">byte</span>[] input, <span class="built_in">byte</span>[] key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> aesAlg = <span class="keyword">new</span> AesManaged</span><br><span class="line">            &#123;</span><br><span class="line">                KeySize = <span class="number">128</span>,</span><br><span class="line">                Key = key,</span><br><span class="line">                BlockSize = <span class="number">128</span>,</span><br><span class="line">                Mode = CipherMode.ECB,</span><br><span class="line">                Padding = PaddingMode.PKCS7,</span><br><span class="line">                IV = <span class="keyword">new</span> <span class="built_in">byte</span>[] &#123; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            ICryptoTransform encryptor = aesAlg.CreateDecryptor(aesAlg.Key, aesAlg.IV);</span><br><span class="line">            <span class="keyword">return</span> encryptor.TransformFinalBlock(input, <span class="number">0</span>, input.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DexFile</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">JsonProperty(<span class="string">&quot;dexLength&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Length &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">JsonProperty(<span class="string">&quot;dexName&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如图所示：</p>
<p><img src="./pic6.jpg" alt="写个程序验证猜想"></p>
<h2 id="逆向成功"><a href="#逆向成功" class="headerlink" title="逆向成功"></a>逆向成功</h2><p>用 dex2jar 转换一下解密得到的两个 dex 文件，提示都有错误！但是应该不是很大的错误，因为我还是得到了两个 jar 文件。</p>
<blockquote>
<p>有很多个错误，但是都是同一个错误：java.lang.RuntimeException: can not merge I and Z。查资料后发现，这是 java 无法把 int类型 转化为 Boolean类型，所以在严格的类型检查下报错了。</p>
</blockquote>
<p>使用 jd-gui 成功打开这两个 jar 文件：</p>
<p><img src="./pic7.jpg" alt="成功反编译classes.dex"></p>
<p><img src="./pic8.jpg" alt="成功反编译classes2.dex"></p>
<p>搜一下字符串，成功搜索到期待的字符串。</p>
<p><img src="./pic9.jpg" alt="成功搜索到想要的字符"></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>青果教务系统安卓APP(喜鹊儿)逆向分析</p><p><a href="https://uint128.com/2020/08/20/青果教务系统安卓APP-喜鹊儿-逆向分析/">https://uint128.com/2020/08/20/青果教务系统安卓APP-喜鹊儿-逆向分析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>uint128.com</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-08-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-08-22</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/08/21/%E9%9D%92%E6%9E%9C%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9FAPP%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">青果教务系统APP网络协议加密算法分析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/19/%E9%BB%98%E8%AE%A4%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%9E%84%E9%80%A0%E8%A1%8C%E4%B8%BA/"><span class="level-item">默认构造函数的构造行为</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "eb55d1c7e1884a9e3cfddd2d269025db",
            repo: "cyanray.github.io",
            owner: "cyanray",
            clientID: "53e3c578fcb7b7b1a4da",
            clientSecret: "74433ee77d6e13fd635b82add519e143ac791726",
            admin: ["cyanray"],
            createIssueManually: true,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#基本分析"><span class="level-left"><span class="level-item">1</span><span class="level-item">基本分析</span></span></a></li><li><a class="level is-mobile" href="#柳暗花明"><span class="level-left"><span class="level-item">2</span><span class="level-item">柳暗花明</span></span></a></li><li><a class="level is-mobile" href="#逆向成功"><span class="level-left"><span class="level-item">3</span><span class="level-item">逆向成功</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-29T09:02:24.000Z">2023-04-29</time></p><p class="title"><a href="/2023/04/29/C-Concepts-%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%8A%80%E5%B7%A7/">C++ Concepts 的两个技巧</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-16T17:24:21.000Z">2023-03-17</time></p><p class="title"><a href="/2023/03/17/%E7%8C%AB%E5%A8%98-NNLL-UINT128/">猫娘 NNLL - UINT128</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-06T15:23:32.000Z">2023-03-06</time></p><p class="title"><a href="/2023/03/06/Modern-CMake-%E5%AE%9E%E8%B7%B5/">Modern CMake 实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-07T18:40:09.000Z">2023-01-08</time></p><p class="title"><a href="/2023/01/08/%E7%89%9B%E9%A1%BF%E6%8F%92%E5%80%BC%E6%B3%95%E7%9A%84-Matlab-%E5%AE%9E%E7%8E%B0/">牛顿插值法的 Matlab 实现</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-07T18:38:42.000Z">2023-01-08</time></p><p class="title"><a href="/2023/01/08/%E5%A4%9A%E5%85%83%E7%89%9B%E9%A1%BF%E8%BF%AD%E4%BB%A3%E6%B3%95%E7%9A%84-Matlab-%E5%AE%9E%E7%8E%B0/">多元牛顿迭代法的 Matlab 实现</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://yuanxingxing-yxx.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">星星的博客</span></span><span class="level-right"><span class="level-item tag">yuanxingxing-yxx.github.io</span></span></a></li><li><a class="level is-mobile" href="http://quosimodo.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">卡西莫多の礼物</span></span><span class="level-right"><span class="level-item tag">quosimodo.cn</span></span></a></li><li><a class="level is-mobile" href="https://blog.icepie.net/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">icepie&#039;s blog</span></span><span class="level-right"><span class="level-item tag">blog.icepie.net</span></span></a></li><li><a class="level is-mobile" href="https://www.cnblogs.com/sherlson" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sherlson&#039;s blog</span></span><span class="level-right"><span class="level-item tag">www.cnblogs.com</span></span></a></li><li><a class="level is-mobile" href="http://blog.devilwst.top/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">小生的技术成长路线</span></span><span class="level-right"><span class="level-item tag">blog.devilwst.top</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">uint128&#039;s Blog</a><p class="is-size-7"><span>&copy; 2023 uint128.com</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/js/imaegoo/universe.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>